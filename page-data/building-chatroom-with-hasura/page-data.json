{"componentChunkName":"component---src-templates-blog-post-js","path":"/building-chatroom-with-hasura/","result":{"data":{"site":{"siteMetadata":{"title":"Mohamed Shadab","author":"Mohamed Shadab"}},"markdownRemark":{"id":"fa95e404-92c7-53d1-b08a-591f638108bc","excerpt":"You will be learning how to set up Hasura and will learn how to write specific GraphQL queries which help you build this Web App. Most of the react code is‚Ä¶","html":"<p>You will be learning how to set up Hasura and will learn how to write specific GraphQL queries which help you build this Web App.</p>\n<blockquote>\n<p>Most of the react code is already written and the tutorial branch has only the GraphQL logic/code missing from it. However you can choose to build from scratch while taking reference from <a href=\"https://github.com/statebait/hasura-chatroom-demo.git\">https://github.com/statebait/hasura-chatroom-demo.git</a></p>\n</blockquote>\n<h3>Setting up Hasura &#x26; the Database</h3>\n<ul>\n<li>\n<p>To follow the tutorial you will need the tutorial branch of the repository; clone the repository like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> clone --single-branch --branch tutorial https://github.com/statebait/hasura-chatroom-demo.git</code></pre></div>\n</li>\n<li>\n<p>Next, you need to start the docker containers for the PostgreSQL database and Hasura GraphQL Engine. Run the following for that inside the repo:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker-compose up -d</code></pre></div>\n</li>\n<li>\n<p>This will spin up both the containers and now the Hasura console should be available at:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">http://localhost:8080/console</code></pre></div>\n<p>If for some reason nothing appears, try running the docker command again.</p>\n</li>\n<li>Get familiar with the console üòÉ. Navigate to the ‚ÄúDATA‚Äù tab and here we will create all the tables we need for the Chatroom Web App.</li>\n<li>Go ahead and click on ‚ÄòCreate Table‚Äô next to the Schema heading.</li>\n<li>\n<p>The first table we will be creating is the ‚Äòusers‚Äô table. Name the table ‚Äòusers‚Äô, add a column called username with column_type as Text. Add this column as the primary key. Finally, click ‚ÄúAdd Table‚Äù below.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">table_name: users\nColumns:\ncolumn_name: username (Primary Key)\ncolumn_type: Text</code></pre></div>\n</li>\n<li>\n<p>Next, we need a table for chatrooms. Create this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">table_name: chatrooms\nColumns:\n#1\ncolumn_name: id (Primary Key)\ncolumn_type: Integer Auto-Increment\n#2\ncolumn_name: name (Unique)\ncolumn_type: Text</code></pre></div>\n</li>\n<li>\n<p>Finally, we need to create a table for the messages, here we‚Äôll need to add 2 Foreign Keys for the chatroom and user.</p>\n<p>Create this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">table_name: messages\nColumns:\n#1\ncolumn_name: id (Primary Key)\ncolumn_type: Integer Auto-Increment\n#2\ncolumn_name: text\ncolumn_type: Text\n#3\ncolumn_name: chatroom_id (Foreign Key)\ncolumn_type: Integer\n#4\ncolumn_name: user (Foreign Key)\ncolumn_type: Text</code></pre></div>\n<p>Now navigate below to the Foreign Key section and add the first foreign key from the table chatrooms:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">messages.chatroom_id -&gt; chatrooms.id</code></pre></div>\n<p>And not the second foreign key from the table users:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">messages.user -&gt; users.username</code></pre></div>\n<p>Great! Now you are done with adding the tables!</p>\n</li>\n<li>Go ahead and click on the chatrooms table and go to the ‚ÄòInsert Rows‚Äô tab. Here add one chatroom with any name you like. (You can add multiple too üòá).</li>\n<li>Now go to the ‚ÄúGRAPHIQL‚Äù tab. This is a GraphQL playground where you can play and test different queries before adding them to your Apps. In this demo, we will deal with all the 3 types of queries available in GraphQL - Query, Mutation, Subscription.</li>\n<li>In the ‚ÄòExplorer‚Äô (If you can‚Äôt see there should be a button to named ‚ÄòExplorer‚Äô to open it up) you will see a bunch of queries already there which you can just click on and add. In the bottom part of the Explorer, you can add (switch) to Mutations/Subscriptions.</li>\n</ul>\n<h3>Building the Web App</h3>\n<p>The React app consist of three views:</p>\n<ul>\n<li>Login</li>\n<li>Chatroom List</li>\n<li>Chatroom</li>\n</ul>\n<p>The tutorial branch has all the code for the working demo except all the GraphQL related logic, which is the main focus of this tutorial.</p>\n<p>So let‚Äôs begin!</p>\n<p>Install dependencies by running the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">yarn</span></code></pre></div>\n<h4>Apollo Setup</h4>\n<p>We will be using the <a href=\"https://www.apollographql.com/docs/react/\">Apollo Client (React)</a> for querying the GraphQL API generated by Hasura</p>\n<p>Start by creating a file called <code class=\"language-text\">apollo.js</code> inside of the <code class=\"language-text\">src</code> folder.</p>\n<p>The file should have this:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> ApolloClient <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"apollo-client\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> WebSocketLink <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"apollo-link-ws\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> HttpLink <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"apollo-link-http\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> split <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"apollo-link\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> getMainDefinition <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"apollo-utilities\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> InMemoryCache <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"apollo-cache-inmemory\"</span>\n\n<span class=\"token keyword\">const</span> wsLink <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WebSocketLink</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  uri<span class=\"token operator\">:</span> <span class=\"token string\">\"ws://localhost:8080/v1/graphql\"</span><span class=\"token punctuation\">,</span>\n  options<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    reconnect<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> httpLink <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpLink</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  uri<span class=\"token operator\">:</span> <span class=\"token string\">\"http://localhost:8080/v1/graphql\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> link <span class=\"token operator\">=</span> <span class=\"token function\">split</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> query <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> definition <span class=\"token operator\">=</span> <span class=\"token function\">getMainDefinition</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      definition<span class=\"token punctuation\">.</span>kind <span class=\"token operator\">===</span> <span class=\"token string\">\"OperationDefinition\"</span> <span class=\"token operator\">&amp;&amp;</span>\n      definition<span class=\"token punctuation\">.</span>operation <span class=\"token operator\">===</span> <span class=\"token string\">\"subscription\"</span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  wsLink<span class=\"token punctuation\">,</span>\n  httpLink\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> cache <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InMemoryCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApolloClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  cache<span class=\"token operator\">:</span> cache<span class=\"token punctuation\">,</span>\n  link<span class=\"token punctuation\">,</span>\n  name<span class=\"token operator\">:</span> <span class=\"token string\">\"react-web-client\"</span><span class=\"token punctuation\">,</span>\n  version<span class=\"token operator\">:</span> <span class=\"token string\">\"1.3\"</span><span class=\"token punctuation\">,</span>\n  queryDeduplication<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  defaultOptions<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    watchQuery<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      fetchPolicy<span class=\"token operator\">:</span> <span class=\"token string\">\"cache-and-network\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>In the above code, we use 2 links and a split method which dynamically switches the link depending on the type of operation. We need this functionality because we will be using subscriptions which don‚Äôt use the regular http connection and instead use a web socket connection.</p>\n<h4>Login View</h4>\n<p>The Login View has a simple input box where one can enter their name; on entering the name a mutation to create a user is made in the database, the ‚ÄòUSER‚Äô key is added to local storage for future use and finally, the user is navigated to the chatrooms view.</p>\n<p>In <code class=\"language-text\">src/components/Login.js</code></p>\n<p>Add the following imports:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> gql <span class=\"token keyword\">from</span> <span class=\"token string\">\"graphql-tag\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useMutation <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@apollo/react-hooks\"</span></code></pre></div>\n<p>Next, we need a mutation to add the user to the database:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token constant\">ADD_USER</span> <span class=\"token operator\">=</span> gql<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n  mutation addUser($user: String) {\n    insert_users(objects: { username: $user }) {\n      affected_rows\n    }\n  }\n</span><span class=\"token template-punctuation string\">`</span></span></code></pre></div>\n<p>Then add this hook to the Login component that uses the mutation:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>addUser<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> error <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useMutation</span><span class=\"token punctuation\">(</span><span class=\"token constant\">ADD_USER</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>The <code class=\"language-text\">addUser</code> in the above code is a promise given to you. We need to execute it on submit so add this to the onSubmit function inside the <code class=\"language-text\">if</code> block:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token function\">addUser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  variables<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    user<span class=\"token operator\">:</span> value<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    window<span class=\"token punctuation\">.</span>localStorage<span class=\"token punctuation\">.</span><span class=\"token function\">setItem</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"USER\"</span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span>\n    <span class=\"token function\">handleLogin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h4>Chatroom List View</h4>\n<p>The Chatroom List View is a simple list of clickable chatrooms available. It requires a simple query to fetch the chatrooms.</p>\n<p>In <code class=\"language-text\">src/components/ChatroomList.js</code></p>\n<p>Add the following imports:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useQuery <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@apollo/react-hooks\"</span>\n<span class=\"token keyword\">import</span> gql <span class=\"token keyword\">from</span> <span class=\"token string\">\"graphql-tag\"</span></code></pre></div>\n<p>Next, we need a query to fetch the chatrooms from the database:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token constant\">GET_CHATROOMS</span> <span class=\"token operator\">=</span> gql<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n  {\n    chatrooms {\n      name\n      id\n    }\n  }\n</span><span class=\"token template-punctuation string\">`</span></span></code></pre></div>\n<p>Then add this hook to the ChatroomList component that uses the query:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> loading<span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">,</span> data <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useQuery</span><span class=\"token punctuation\">(</span><span class=\"token constant\">GET_CHATROOMS</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h4>Chatroom view</h4>\n<p>The Chatroom View is the crux of the Web App, it displays the list of messages sent in the chatroom and an input field to send more messages.</p>\n<p>In <code class=\"language-text\">src/components/Chatroom.js</code></p>\n<p>Add the following imports:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useSubscription<span class=\"token punctuation\">,</span> useMutation <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@apollo/react-hooks\"</span>\n<span class=\"token keyword\">import</span> gql <span class=\"token keyword\">from</span> <span class=\"token string\">\"graphql-tag\"</span></code></pre></div>\n<p>We need a subscription for the messages and a mutation to add a message to the database;</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token constant\">MESSAGE_SUBSCRIPTION</span> <span class=\"token operator\">=</span> gql<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n  subscription messageSubscription($chatroomId: Int!) {\n    messages(where: { chatroom_id: { _eq: $chatroomId } }) {\n      id\n      text\n      user\n    }\n  }\n</span><span class=\"token template-punctuation string\">`</span></span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">SEND_MESSAGE</span> <span class=\"token operator\">=</span> gql<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n  mutation sendMessage($chatroomId: Int, $text: String, $user: String) {\n    insert_messages(\n      objects: { chatroom_id: $chatroomId, text: $text, user: $user }\n    ) {\n      affected_rows\n    }\n  }\n</span><span class=\"token template-punctuation string\">`</span></span></code></pre></div>\n<p>Add the following hooks to use the above subscription and mutation:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> loading<span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">,</span> data <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useSubscription</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MESSAGE_SUBSCRIPTION</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  variables<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    chatroomId<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>sendMessage<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useMutation</span><span class=\"token punctuation\">(</span><span class=\"token constant\">SEND_MESSAGE</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Vola! You should have a working application!</p>","frontmatter":{"title":"Building a Chatroom Web App with Hasura","date":"May 15, 2020","description":"Learn how to build a Chatroom Web App powered with a GraphQL API using Hasura & React"}}},"pageContext":{"slug":"/building-chatroom-with-hasura/","previous":{"fields":{"slug":"/yoctosehns-software-architecture/"},"frontmatter":{"title":"Yoctosehns Software Architecture"}},"next":null}},"staticQueryHashes":["63159454","734670849"]}